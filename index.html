<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DCAS CPG 2025 Review Platform</title>
    
    <script src="content.js"></script>

    <script>
    /* Viewport Fix - Runs immediately */
    function setVH() {
        document.documentElement.style.setProperty('--vh', window.innerHeight * 0.01 + 'px');
    }
    setVH();
    window.addEventListener('resize', setVH);
    window.addEventListener('orientationchange', setVH);
    </script>

    <style>
        :root {
            /* Aero Vista / Glassmorphism Palette */
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            
            --text-dark: #1a2a3a;
            --text-light: #ffffff;
            
            --primary-blue: #0056b3;
            --accent-blue: #007bff;
            --accent-green: #28a745;
            --accent-red: #dc3545;
            --accent-gold: #ffc107;
            
            /* Background */
            --bg-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-gradient);
            margin: 0;
            padding: 0;
            padding-top: env(safe-area-inset-top);
            color: var(--text-dark);
            min-height: calc(var(--vh, 1vh) * 100);
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
            overflow-x: hidden;
        }

        /* --- GLASS HEADER --- */
        header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px; 
            position: sticky;
            top: 0;
            z-index: 1000;
            color: white;
        }

        .home-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 14px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            display: none; 
        }

        .header-text h1 { margin: 0; font-size: 1.1rem; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .header-text p { margin: 2px 0 0; font-size: 0.8rem; opacity: 0.8; }

        .score-badge {
            margin-left: auto;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
        }

        /* --- MAIN CONTAINER --- */
        main {
            flex: 1 0 auto;
            min-height: 0;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: 90px; /* Space for bottom nav */
        }

        /* --- CHAPTER GRID --- */
        .chapter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
        }

        .chapter-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.1s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 130px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .chapter-card:active { transform: scale(0.96); }
        
        .chapter-num { 
            font-size: 0.75rem; 
            color: var(--primary-blue); 
            font-weight: 800; 
            text-transform: uppercase; 
            margin-bottom: 8px;
            letter-spacing: 1px;
        }
        
        .chapter-title { font-size: 1rem; font-weight: 600; color: var(--text-dark); line-height: 1.3; }
        .chapter-desc { font-size: 0.75rem; color: #666; margin-top: 5px; }

        /* --- GENERIC CARDS --- */
        .glass-card, .menu-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--glass-shadow);
        }

        .menu-card h2 { margin-top: 0; color: var(--primary-blue); }

        /* --- BUTTONS --- */
        .menu-sub-options { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        
        .btn, .btn-action, .control-btn, .option-btn {
            -webkit-user-select: none;
            user-select: none;
        }

        .btn-action {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.1s;
            min-width: 100px;
        }
        .btn-action:active { transform: scale(0.98); }
        
        .btn-flash { background: #e3f2fd; color: #0056b3; }
        .btn-quiz { background: #e8f5e9; color: #155724; }
        .btn-summary { background: #fff3cd; color: #856404; }
        .btn-disabled { opacity: 0.5; cursor: not-allowed; background: #eee; color: #999; }

        /* --- QUIZ UI --- */
        .quiz-container {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--glass-shadow);
        }

        .quiz-question { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; color: #222; }

        .quiz-option {
            width: 100%;
            padding: 16px;
            margin-bottom: 10px;
            border: 1px solid rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.6);
            border-radius: 12px;
            text-align: left;
            font-size: 1rem;
            cursor: pointer;
        }
        .quiz-option:disabled { opacity: 0.8; cursor: default; }
        .quiz-option.correct { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .quiz-option.wrong { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }

        .quiz-feedback {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.9);
            border-radius: 12px;
            border-left: 4px solid #999;
            display: none;
        }

        .control-btn { 
            padding: 12px 30px; border: none; background: var(--primary-blue); 
            color: white; border-radius: 30px; font-weight: 600; cursor: pointer; 
            box-shadow: 0 4px 10px rgba(0,86,179,0.3);
        }

        /* --- FLASHCARDS --- */
        .scene { width: 100%; height: 320px; perspective: 1000px; margin: 20px 0; cursor: pointer; }
        .card { width: 100%; height: 100%; position: relative; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .card.is-flipped { transform: rotateY(180deg); }
        .card__face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 25px; box-sizing: border-box; text-align: center; border-radius: 20px;
            background: rgba(255,255,255,0.95); transform: translateZ(0);
        }
        .card__face--front { border: 2px solid #f0f0f0; color: var(--primary-blue); font-weight: 600; font-size: 1.1rem; }
        .card__face--back { background: linear-gradient(135deg, #0056b3, #004494); color: white; transform: rotateY(180deg); overflow-y: auto; }

        /* --- STYLES --- */
        .highlight-box {
            background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 12px;
            margin-top: 15px; border-left: 4px solid var(--accent-red);
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); font-size: 0.95rem; color: #333;
            animation: fadeIn 0.3s ease;
        }

        .critical-card { border-left: 5px solid var(--accent-red); background: #fff5f5; }
        .completion-card { text-align: center; padding: 30px; }
        .completion-icon { font-size: 3rem; margin-bottom: 15px; display: block; }

        .stats-container { display: grid; gap: 15px; grid-template-columns: 1fr 1fr; margin-bottom: 20px; }
        .stat-card {
            background: rgba(255,255,255,0.6); padding: 15px; border-radius: 12px;
            text-align: center; border: 1px solid rgba(255,255,255,0.5);
        }
        .stat-value { font-size: 1.8rem; font-weight: 800; color: var(--primary-blue); }
        .stat-label { font-size: 0.7rem; color: #555; text-transform: uppercase; letter-spacing: 1px; }
        .weakest-link { background: #fff5f5; border-color: #ffcdd2; color: #c62828; }

        .flashcard-nav {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 20px; background: rgba(255,255,255,0.3);
            padding: 10px; border-radius: 30px;
        }
        .nav-arrow {
            background: white; border: none; width: 40px; height: 40px;
            border-radius: 50%; font-weight: bold; color: var(--primary-blue);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .nav-arrow:active { transform: scale(0.9); }

        .difficulty-badge {
            font-size: 0.65rem; padding: 2px 6px; border-radius: 4px;
            margin-left: 8px; text-transform: uppercase; font-weight: 700;
        }
        .diff-basic { background: #e3f2fd; color: #0d47a1; }
        .diff-advanced { background: #fff3cd; color: #856404; }
        .diff-scenario { background: #e8f5e9; color: #1b5e20; }

        .review-card { border-left: 4px solid var(--accent-gold); background: #fff9e6; text-align: left; }
        .review-answer {
            margin-top: 10px; padding: 10px; background: white;
            border-radius: 8px; font-size: 0.9rem; color: #444;
        }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255,255,255,0.5);
            display: flex; justify-content: space-around;
            padding: 12px 0; padding-bottom: calc(12px + env(safe-area-inset-bottom));
            z-index: 2000; box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }
        .nav-item { 
            background: none; border: none; 
            font-size: 0.75rem; color: #666; font-weight: 600; 
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            cursor: pointer;
        }
        .nav-icon { font-size: 1.2rem; }

        footer { 
            text-align: center; padding: 20px; color: rgba(255,255,255,0.6); font-size: 0.75rem; 
            margin-bottom: 20px;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <header>
        <button class="home-btn" id="homeBtn" onclick="app.goHome()">‚Üê</button>
        <div class="header-text">
            <h1 id="pageTitle">DCAS CPG 2025</h1>
            <p id="pageSubtitle">Clinical Review Hub</p>
        </div>
        <div class="score-badge" onclick="app.showStats()">üèÜ Stats</div>
    </header>

    <main id="app-container">
        </main>

    <footer>
        Created by Soliman Anas ‚Ä¢ Educational Aid Only<br>
        Refer to Official DCAS Guidelines
    </footer>

    <nav class="bottom-nav">
        <button onclick="app.goHome()" class="nav-item">
            <span class="nav-icon">üìö</span> Chapters
        </button>
        <button onclick="app.startCriticalMode()" class="nav-item">
            <span class="nav-icon">üö®</span> Red Flags
        </button>
        <button onclick="app.showStats()" class="nav-item">
            <span class="nav-icon">üìä</span> Progress
        </button>
    </nav>

<script>
(function() {
    "use strict";

    // Global Error Logger
    window.addEventListener('error', function(e) {
        console.warn("DCAS App Error:", e.message);
    });

    // 2. STORAGE ENGINE
    const Storage = {
        get: function() {
            try {
                return JSON.parse(localStorage.getItem('dcas_stats_v3')) || { totalAttempts: 0, chapters: {}, critical: { total: 0, correct: 0 } };
            } catch(e) {
                return { totalAttempts: 0, chapters: {}, critical: { total: 0, correct: 0 } };
            }
        },
        saveResult: function(chapterId, score, totalQuestions) {
            try {
                let stats = this.get();
                stats.totalAttempts++;
                if (!stats.chapters[chapterId]) {
                    stats.chapters[chapterId] = { attempts: 0, totalScore: 0, totalMax: 0 };
                }
                let ch = stats.chapters[chapterId];
                ch.attempts++;
                ch.totalScore += score;
                ch.totalMax += totalQuestions;
                localStorage.setItem('dcas_stats_v3', JSON.stringify(stats));
            } catch(e) {}
        },
        saveCritical: function(score) {
            try {
                let stats = this.get();
                if(!stats.critical) stats.critical = { total: 0, correct: 0 };
                stats.critical.total++;
                if(score > 0) stats.critical.correct++;
                localStorage.setItem('dcas_stats_v3', JSON.stringify(stats));
            } catch(e) {}
        }
    };

    // 3. UI CONTROLLER
    const UI = {
        container: document.getElementById('app-container'),
        title: document.getElementById('pageTitle'),
        subtitle: document.getElementById('pageSubtitle'),
        backBtn: document.getElementById('homeBtn'),

        resetScroll: function() {
            window.scrollTo(0,0);
            setTimeout(() => window.scrollTo(0,0), 10);
        },

        updateHeader: function(title, sub, showBack) {
            this.title.innerText = title;
            this.subtitle.innerText = sub || "";
            this.backBtn.style.display = showBack ? 'block' : 'none';
        },

        renderHome: function() {
            // Check if Content Loaded
            if (typeof CPG_CONTENT === 'undefined') {
                this.container.innerHTML = `<div style="text-align:center; padding:20px; color:white;">
                    <h2>Loading Data...</h2>
                    <p>Please ensure content.js is in the same folder.</p>
                </div>`;
                return;
            }

            this.container.innerHTML = `<div class="chapter-grid" id="chapterList"></div>`;
            const list = document.getElementById('chapterList');
            
            CPG_CONTENT.chapters.forEach(chap => {
                const card = document.createElement('div');
                card.className = 'chapter-card';
                card.innerHTML = `
                    <div class="chapter-num">${chap.id.toUpperCase()}</div>
                    <div class="chapter-title">${chap.title}</div>
                    <div style="font-size:0.75rem; color:#666; margin-top:5px;">${chap.desc}</div>
                `;
                card.onclick = () => app.navigate(`chapter/${chap.id}`);
                list.appendChild(card);
            });
            this.updateHeader("DCAS CPG 2025", "Clinical Review Hub", false);
            this.resetScroll();
        },

        renderChapterMenu: function(chapter) {
            const quizBtn = chapter.hasQuiz 
                ? `<button class="btn-action btn-quiz" onclick="app.navigate('quiz/${chapter.id}')">Start Quiz</button>` 
                : `<button class="btn-action btn-disabled">Quiz N/A</button>`;
                
            const flashBtn = chapter.hasFlashcards 
                ? `<button class="btn-action btn-flash" onclick="app.navigate('flashcards/${chapter.id}')">Flashcards</button>` 
                : `<button class="btn-action btn-disabled">Cards N/A</button>`;

            this.container.innerHTML = `
                <div class="menu-card active-card">
                    <h2>${chapter.title}</h2>
                    <p>${chapter.desc}</p>
                    <div class="menu-sub-options">
                        <button class="btn-action btn-summary" onclick="alert('Summary coming soon')">Summary</button>
                        ${flashBtn}
                        ${quizBtn}
                    </div>
                </div>
            `;
            this.updateHeader(chapter.title, "Select Module", true);
            this.resetScroll();
        },

        renderStats: function() {
            const stats = Storage.get();
            let weakestChap = "None";
            let minAvg = 101;
            let breakdowns = "";
            
            for (const [id, data] of Object.entries(stats.chapters)) {
                let avg = data.totalMax > 0 ? Math.round((data.totalScore / data.totalMax) * 100) : 0;
                if (avg < minAvg && data.totalMax > 0) { minAvg = avg; weakestChap = id.toUpperCase(); }
                breakdowns += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee;"><span>${id.toUpperCase()}</span> <b>${avg}%</b></div>`;
            }

            const critAvg = stats.critical && stats.critical.total > 0 
                ? Math.round((stats.critical.correct / stats.critical.total) * 100) 
                : 0;

            this.container.innerHTML = `
                <div class="menu-card">
                    <h2>Performance Analytics</h2>
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-value">${stats.totalAttempts}</div>
                            <div class="stat-label">Quizzes</div>
                        </div>
                        <div class="stat-card ${critAvg < 80 ? 'weakest-link' : ''}">
                            <div class="stat-value">${critAvg}%</div>
                            <div class="stat-label">Critical Decisions</div>
                        </div>
                    </div>
                    <div style="margin-top:20px; background:white; padding:15px; border-radius:12px;">
                        <h3 style="font-size:1rem; margin-top:0;">Chapter Breakdown</h3>
                        ${breakdowns || "<p>No data yet.</p>"}
                    </div>
                </div>
            `;
            this.updateHeader("My Stats", "Learning Progress", true);
            this.resetScroll();
        },

        renderFlashcard: function(data, index, total) {
            this.container.innerHTML = `
                <div id="flashcard-section" class="section active">
                    <div style="text-align: center; color: #666; margin-bottom: 10px; font-weight: 500;">
                        Card ${index + 1} of ${total}
                    </div>
                    <div class="scene" id="cardScene">
                        <div class="card" id="flashcard">
                            <div class="card__face card__face--front">
                                <span class="category-badge">${data.category}</span>
                                <div id="fc-question" style="font-size:1.1rem; line-height:1.4;">${data.question}</div>
                                <div style="font-size: 0.8rem; color: #999; margin-top: 20px;">(Tap to Flip)</div>
                            </div>
                            <div class="card__face card__face--back">
                                <div id="fc-answer" style="white-space: pre-wrap;">${data.answer}</div>
                            </div>
                        </div>
                    </div>
                    <div class="flashcard-nav">
                        <button class="nav-arrow" id="prevCardBtn">‚Üê</button>
                        <span style="font-size:0.8rem; font-weight:bold; color:#666;">Navigation</span>
                        <button class="nav-arrow" id="nextCardBtn">‚Üí</button>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                const s = document.getElementById('cardScene');
                const p = document.getElementById('prevCardBtn');
                const n = document.getElementById('nextCardBtn');
                
                if(s) s.addEventListener('click', app.flipCard, {passive:true});
                if(p) p.addEventListener('click', (e) => { e.stopPropagation(); app.prevCard(); });
                if(n) n.addEventListener('click', (e) => { e.stopPropagation(); app.nextCard(); });
            }, 50);
            
            this.updateHeader("Flashcards", "Review Mode", true);
        },

        renderQuiz: function(qData, current, total, score) {
            const diffClass = `diff-${qData.difficulty || 'basic'}`;
            const diffLabel = (qData.difficulty || 'BASIC').toUpperCase();

            this.container.innerHTML = `
                <div class="quiz-container">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <span>Q ${current + 1}/${total} <span class="difficulty-badge ${diffClass}">${diffLabel}</span></span>
                        <span>Score: <span id="liveScore">${score}</span></span>
                    </div>
                    <div class="quiz-question">${qData.q}</div>
                    <div class="quiz-options" id="opts"></div>
                    <div id="feedback" class="quiz-feedback"></div>
                    <button id="nextBtn" class="control-btn" style="width:100%; margin-top:20px; display:none;">Next</button>
                </div>
            `;

            const optsDiv = document.getElementById('opts');
            qData.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = 'quiz-option';
                btn.innerText = opt;
                btn.onclick = () => app.handleAnswer(idx, btn);
                optsDiv.appendChild(btn);
            });
            this.updateHeader("Clinical Quiz", "Testing Mode", true);
            this.resetScroll();
        },

        renderReview: function(mistakes) {
            let html = `<div class="quiz-setup-container"><h2>Review Mistakes</h2><p>${mistakes.length} items to review</p>`;
            
            mistakes.forEach((m, i) => {
                html += `
                    <div class="menu-card review-card" style="margin-bottom:15px; text-align:left;">
                        <strong>Q${i+1}: ${m.q}</strong>
                        <div class="review-answer">‚úÖ ${m.options[m.correct]}</div>
                        <div style="font-size:0.85rem; color:#666; margin-top:5px;">‚ÑπÔ∏è ${m.rationale}</div>
                    </div>
                `;
            });
            
            html += `<button class="control-btn" style="width:100%;" onclick="app.goHome()">Finish Review</button></div>`;
            this.container.innerHTML = html;
            this.resetScroll();
        },

        renderCriticalComplete: function(score, total) {
            const percent = Math.round((score/total)*100);
            this.container.innerHTML = `
                <div class="menu-card completion-card">
                    <span class="completion-icon">üö®</span>
                    <h2>Drill Complete</h2>
                    <p>Critical Decision Accuracy</p>
                    <div style="font-size:3rem; font-weight:800; color:${percent >= 80 ? 'var(--accent-green)' : 'var(--accent-red)'}; margin:20px 0;">
                        ${percent}%
                    </div>
                    <p style="font-size:0.9rem; color:#666;">
                        ${percent >= 80 ? "Strong situational awareness." : "Review red flag triggers."}
                    </p>
                    <button class="control-btn" style="width:100%;" onclick="app.goHome()">Back to Menu</button>
                </div>
            `;
            this.updateHeader("Drill Report", "", true);
        },

        renderCriticalMode: function(sData, current, total) {
            this.container.innerHTML = `
                <div class="menu-card critical-card">
                    <h2 style="color:#dc3545;">üö® SCENARIO ${current + 1}/${total}</h2>
                    <p style="font-size:1.1rem; font-weight:500; margin:15px 0;">${sData.scenario}</p>
                    <div id="decisions" style="display:flex; flex-direction:column; gap:10px;"></div>
                    <div id="s-feedback" class="highlight-box" style="display:none;"></div>
                    <button id="nextSBtn" class="control-btn" style="width:100%; margin-top:15px; display:none; background:#dc3545;">Next Case</button>
                </div>
            `;
            
            const dGrid = document.getElementById('decisions');
            sData.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = 'quiz-option';
                btn.innerText = opt.t;
                btn.onclick = () => app.handleCriticalAnswer(idx, btn);
                dGrid.appendChild(btn);
            });
            this.updateHeader("Red Flag Drill", "Critical Decision Making", true);
            this.resetScroll();
        }
    };

    // ==========================================
    //           4. APP CONTROLLER
    // ==========================================
    const App = {
        state: {
            quizData: [],
            mistakes: [], 
            qIndex: 0,
            score: 0,
            activeChapter: null,
            flashData: [],
            fIndex: 0,
            criticalScore: 0
        },

        navigate: (hash) => {
            window.location.hash = hash;
        },

        handleRoute: () => {
            const hash = window.location.hash.slice(1) || 'home';
            const parts = hash.split('/');
            const route = parts[0];
            const id = parts[1];

            if (route === 'home') UI.renderHome();
            else if (route === 'chapter') UI.renderChapterMenu(CPG_CONTENT.chapters.find(c => c.id === id));
            else if (route === 'quiz') App.startQuiz(id);
            else if (route === 'flashcards') App.startFlashcards(id);
            else if (route === 'critical') App.startCriticalMode();
            else if (route === 'stats') UI.renderStats();
            else UI.renderHome();
        },

        goHome: () => App.navigate('home'),
        showStats: () => App.navigate('stats'),

        // --- QUIZ ---
        startQuiz: (chapId) => {
            const data = CPG_CONTENT.questions[chapId] || CPG_CONTENT.questions['c1'];
            App.state.quizData = [...data].sort(() => 0.5 - Math.random()).slice(0, 10);
            App.state.qIndex = 0;
            App.state.score = 0;
            App.state.mistakes = []; 
            App.state.activeChapter = chapId;
            UI.renderQuiz(App.state.quizData[0], 0, App.state.quizData.length, 0);
        },

        handleAnswer: (idx, btn) => {
            const qData = App.state.quizData[App.state.qIndex];
            const isCorrect = idx === qData.correct;
            
            const allBtns = document.querySelectorAll('.quiz-option');
            allBtns.forEach(b => b.disabled = true);

            if (isCorrect) {
                btn.classList.add('correct');
                App.state.score++;
                document.getElementById('liveScore').innerText = App.state.score;
            } else {
                btn.classList.add('wrong');
                if (allBtns[qData.correct]) {
                    allBtns[qData.correct].classList.add('correct');
                }
                App.state.mistakes.push(qData);
            }

            const feedback = document.getElementById('feedback');
            feedback.innerHTML = `<strong>${isCorrect ? 'Correct!' : 'Incorrect'}</strong><br>${qData.rationale}`;
            feedback.style.color = isCorrect ? "#155724" : "#721c24";
            feedback.style.display = 'block';

            const nextBtn = document.getElementById('nextBtn');
            nextBtn.style.display = 'block';
            nextBtn.onclick = App.nextQuestion;
        },

        nextQuestion: () => {
            App.state.qIndex++;
            if (App.state.qIndex < App.state.quizData.length) {
                UI.renderQuiz(App.state.quizData[App.state.qIndex], App.state.qIndex, App.state.quizData.length, App.state.score);
            } else {
                Storage.saveResult(App.state.activeChapter, App.state.score, App.state.quizData.length);
                
                const percent = Math.round((App.state.score / App.state.quizData.length) * 100);
                const reviewBtn = App.state.mistakes.length > 0 
                    ? `<button class="control-btn" style="width:100%; margin-bottom:10px; background:#f0ad4e;" onclick="UI.renderReview(App.state.mistakes)">Review Mistakes (${App.state.mistakes.length})</button>` 
                    : '';

                UI.container.innerHTML = `
                    <div class="menu-card">
                        <h2>Quiz Complete</h2>
                        <div style="text-align:center; margin:30px 0;">
                            <div style="font-size:3rem; font-weight:800; color:var(--primary-blue);">
                                ${percent}%
                            </div>
                            <p>Result saved to analytics.</p>
                        </div>
                        ${reviewBtn}
                        <button class="control-btn" style="width:100%;" onclick="app.goHome()">Back to Menu</button>
                    </div>
                `;
                UI.resetScroll();
            }
        },

        // --- FLASHCARDS ---
        startFlashcards: (chapId) => {
            const data = CPG_CONTENT.flashcards[chapId] || CPG_CONTENT.flashcards['c1'];
            if(!data || data.length === 0) { alert("No flashcards for this chapter yet."); return; }
            
            App.state.flashData = data;
            App.state.fIndex = 0;
            UI.renderFlashcard(data[0], 0, data.length);
        },

        flipCard: () => {
            const card = document.getElementById('flashcard');
            if(card) card.classList.toggle('is-flipped');
        },
        
        nextCard: () => {
            if (App.state.fIndex < App.state.flashData.length - 1) {
                App.state.fIndex++;
                UI.renderFlashcard(App.state.flashData[App.state.fIndex], App.state.fIndex, App.state.flashData.length);
            }
        },
        
        prevCard: () => {
            if (App.state.fIndex > 0) {
                App.state.fIndex--;
                UI.renderFlashcard(App.state.flashData[App.state.fIndex], App.state.fIndex, App.state.flashData.length);
            }
        },

        // --- CRITICAL MODE ---
        startCriticalMode: () => {
            App.state.quizData = CPG_CONTENT.criticalScenarios;
            App.state.qIndex = 0;
            App.state.criticalScore = 0;
            UI.renderCriticalMode(App.state.quizData[0], 0, App.state.quizData.length);
        },

        handleCriticalAnswer: (idx, btn) => {
            const sData = App.state.quizData[App.state.qIndex];
            const option = sData.options[idx];
            const isCorrect = option.s > 0;

            if(isCorrect) App.state.criticalScore++;
            Storage.saveCritical(isCorrect ? 1 : 0);

            document.querySelectorAll('#decisions button').forEach(b => b.disabled = true);

            const fb = document.getElementById('s-feedback');
            fb.style.display = 'block';
            fb.innerHTML = `<strong>${isCorrect ? "‚úÖ CORRECT" : "‚ùå INCORRECT"}</strong><br>${option.f}<br><div style="margin-top:10px; font-size:0.85rem; color:#666;">KPI: ${sData.kpi}</div>`;
            
            const next = document.getElementById('nextSBtn');
            next.style.display = 'block';
            next.onclick = () => {
                App.state.qIndex++;
                if (App.state.qIndex < App.state.quizData.length) {
                    UI.renderCriticalMode(App.state.quizData[App.state.qIndex], App.state.qIndex, App.state.quizData.length);
                } else {
                    UI.renderCriticalComplete(App.state.criticalScore, App.state.quizData.length);
                }
            };
        }
    };

    // --- INITIALIZATION ---
    window.app = App;
    window.addEventListener('hashchange', App.handleRoute);
    document.addEventListener('DOMContentLoaded', () => {
        if(window.location.hash) App.handleRoute();
        else App.goHome();
    });

})();
</script>
</body>
</html>
