<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Mobile & iOS optimised -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DCAS CPG 2025 ¬∑ Universal Care</title>
    <style>
        /* ---------- AERO VISTA GLASS THEME (preserved & enhanced) ---------- */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.25);
            --primary-gradient: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            --header-gradient: linear-gradient(to right, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            --text-dark: #1a2a3a;
            --text-light: #ffffff;
            --success-bg: rgba(212, 237, 218, 0.8);
            --success-text: #155724;
            --info-bg: rgba(209, 236, 241, 0.8);
            --info-text: #0c5460;
            --error-bg: rgba(248, 215, 218, 0.8);
            --error-text: #721c24;
            --accent-blue: #0056b3;
            --accent-teal: #0083b0;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--primary-gradient);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            padding-top: env(safe-area-inset-top);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
        }
        /* ----- GLASS HEADER (sticky, blur) ----- */
        header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-light);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .home-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 14px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            display: none;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }
        .home-btn:active { background: rgba(255,255,255,0.4); transform: scale(0.95); }
        .header-text h1 { margin: 0; font-size: 1.2rem; font-weight: 700; letter-spacing: 0.5px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .header-text p { margin: 2px 0 0; font-size: 0.85rem; opacity: 0.9; font-weight: 300; }

        /* ----- MAIN CONTAINER (fluid, centered) ----- */
        main {
            flex: 1 0 auto;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: 80px;
        }
        .section { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .section.active { display: block; opacity: 1; animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* ----- GLASS CARDS ----- */
        .menu-grid { display: grid; gap: 20px; }
        .menu-card, .quiz-container, .quiz-setup-container, .sum-card, .critical-card, .stats-card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: var(--glass-shadow);
            padding: 25px;
            position: relative;
            z-index: 1;
            overflow: hidden;
        }
        .menu-card::before, .quiz-container::before {
            content: ''; position: absolute; top: 0; left: -50%; width: 100%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.3), transparent);
            transform: skewX(-25deg); pointer-events: none;
        }
        .menu-card h2 { margin: 0 0 8px; font-size: 1.3rem; color: #004e92; text-shadow: 0 1px 0 rgba(255,255,255,0.8); }
        .menu-card p { margin: 0 0 20px; color: #444; font-size: 0.95rem; line-height: 1.4; }
        .status-badge {
            display: inline-block; font-size: 0.7rem; padding: 4px 10px;
            border-radius: 20px; background: linear-gradient(to bottom, #f0f0f0, #d9d9d9);
            border: 1px solid #ccc; color: #555; margin-bottom: 12px;
            font-weight: 700; text-transform: uppercase; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* ----- BUTTONS (glossy, no inline onclick) ----- */
        .btn-action, .control-btn, .option-btn, .setup-btn {
            -webkit-user-select: none; user-select: none; cursor: pointer; border: none;
            font-family: inherit; position: relative; z-index: 2; touch-action: manipulation;
        }
        .btn-action {
            flex: 1; padding: 12px 15px; border-radius: 12px; font-weight: 600; font-size: 0.9rem;
            min-width: 100px; color: #333; background: linear-gradient(180deg, #fff 0%, #f0f0f0 100%);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,1);
            border: 1px solid rgba(255,255,255,0.6); transition: all 0.1s ease;
        }
        .btn-action:active { transform: translateY(2px); box-shadow: 0 1px 2px rgba(0,0,0,0.1), inset 0 1px 2px rgba(0,0,0,0.1); }
        .btn-flash { color: #0056b3; background: linear-gradient(180deg, #e3f2fd 0%, #bbdefb 100%); border-color: #90caf9; }
        .btn-quiz { color: #155724; background: linear-gradient(180deg, #e8f5e9 0%, #c3e6cb 100%); border-color: #a5d6a7; }
        .btn-summary { color: #856404; background: linear-gradient(180deg, #fff3cd 0%, #ffeeba 100%); border-color: #ffe8a1; }
        .btn-critical { color: #721c24; background: linear-gradient(180deg, #f8d7da 0%, #f5c6cb 100%); border-color: #f1b0b7; }

        /* ----- FLASHCARD 3D (preserved) ----- */
        .scene { width: 100%; height: 380px; perspective: 1000px; margin: 20px 0; touch-action: pan-y; }
        .card {
            width: 100%; height: 100%; position: relative;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d; border-radius: 24px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2); transform: translateZ(0);
        }
        .card.is-flipped { transform: rotateY(180deg); }
        .card__face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; -webkit-backface-visibility: hidden;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 30px; text-align: center; border-radius: 24px;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.8); transform: translateZ(0);
        }
        .card__face--front { color: #004e92; }
        .category-badge {
            background: #e1f5fe; color: #0277bd; padding: 6px 12px; border-radius: 20px;
            font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px;
        }
        .card__face--back {
            background: linear-gradient(135deg, #005c97 0%, #363795 100%); color: white;
            transform: rotateY(180deg); overflow-y: auto; text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            font-size: 1.1rem; line-height: 1.5; white-space: pre-wrap;
        }

        /* ----- QUIZ / CRITICAL OPTIONS ----- */
        .options-grid, .quiz-options { display: flex; flex-direction: column; gap: 12px; margin-top: 15px; }
        .option-btn {
            padding: 18px; background: rgba(255,255,255,0.8); border: 1px solid rgba(0,0,0,0.05);
            border-radius: 12px; text-align: left; font-size: 1rem; color: #333; line-height: 1.4;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s;
        }
        .option-btn:active { background: #f0f0f0; transform: scale(0.99); }
        .option-btn.correct { background: #d4edda; border-color: #c3e6cb; color: #155724; box-shadow: inset 0 0 0 2px #c3e6cb; }
        .option-btn.wrong { background: #f8d7da; border-color: #f5c6cb; color: #721c24; box-shadow: inset 0 0 0 2px #f5c6cb; }

        .quiz-feedback, .critical-feedback {
            margin-top: 25px; padding: 20px; border-radius: 12px;
            background: rgba(255,255,255,0.9); border-left: 5px solid #ccc; display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .control-btn {
            padding: 14px 35px; border-radius: 30px; font-weight: 600; color: white;
            background: linear-gradient(to bottom, #00b4db, #0083b0);
            box-shadow: 0 4px 15px rgba(0, 131, 176, 0.4); border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.2s; display: inline-block; text-align: center;
        }
        .control-btn:active { transform: scale(0.95); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .setup-grid { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .setup-btn {
            background: white; padding: 18px; border-radius: 15px; font-size: 1rem;
            font-weight: 600; color: #444; display: flex; justify-content: space-between;
            align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: all 0.2s; border: 1px solid transparent;
        }
        .setup-btn:active { transform: scale(0.98); background: #f0f8ff; border-color: #007bff; }
        .setup-btn span { color: #bbb; }
        .red-flag { border-top: 4px solid #dc3545; background: rgba(255,245,245,0.9); }
        .highlight-box { background: rgba(0, 123, 255, 0.1); color: #004085; font-weight: 600; border-left: 4px solid #007bff; padding: 10px; }

        /* ----- MISTAKES PANEL ----- */
        .mistake-item { background: #fff3cd; border-left: 5px solid #ffeeba; padding: 15px; border-radius: 8px; margin-bottom: 12px; }
        .mistake-question { font-weight: 700; }
        .mistake-answer { color: #155724; margin-top: 8px; }
        .mistake-rationale { color: #0c5460; font-style: italic; margin-top: 5px; }

        footer { margin-top: auto; padding: 40px; text-align: center; color: rgba(255,255,255,0.6); font-size: 0.8rem; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
    </style>
</head>
<body>

<!-- ========== HEADER (DYNAMIC) ========== -->
<header>
    <button class="home-btn" id="homeBtn">‚Üê</button>
    <div class="header-text">
        <h1 id="pageTitle">DCAS CPG 2025</h1>
        <p id="pageSubtitle">Universal Care ¬∑ 1.1</p>
    </div>
</header>

<!-- ========== MAIN VIEW CONTAINER ========== -->
<main id="mainContent">
    <!-- Views are injected dynamically via JS -->
</main>

<footer>
    <div>Created by Soliman Anas ¬∑ Study aid only</div>
    <div style="margin-top:5px; opacity:0.6;">Refer to official DCAS CPG & Memos for clinical protocols.</div>
</footer>

<!-- ========== CONTENT.JS ‚Äì CPG 2025 DATA (UNIVERSAL CARE 1.1) ========== -->
<script>
    // ----- GLOBAL CONTENT OBJECT ‚Äì UNIVERSAL CARE 1.1 (60 QUIZ + 60 FLASHCARDS) -----
    const CPG_CONTENT = (function() {
        "use strict";

        const chapterId = "c1";
        const chapterTitle = "Universal Care";
        const shortTitle = "1.1 Universal Care";

<!-- ========== Summary==============
		const summaryHTML = `
    <div class="sum-card">
        <h3 style="color:#0056b3;">üìò Universal Care ‚Äì Full Guideline Summary</h3>
        
        <h4 style="color:#004e92; margin:20px 0 10px;">1. SCENE SAFETY & INITIAL IMPRESSION</h4>
        <ul style="list-style-type: none; padding-left:0;">
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>Scene safety</strong> ‚Äì always first priority (crew, patient, bystanders).</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>General Impression</strong> ‚Äì Appearance, Work of Breathing, Circulation to skin (Pediatric Assessment Triangle).</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>Resource assessment</strong> ‚Äì request ALS / MCI if needed.</li>
        </ul>

        <h4 style="color:#004e92; margin:20px 0 10px;">2. PRIMARY SURVEY (ABCDE / C‚ÄëABC / CAB)</h4>
        <ul style="list-style-type: none; padding-left:0;">
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>Trauma:</strong> C‚ÄëA‚ÄëB‚ÄëC ‚Äì Catastrophic haemorrhage control, C‚Äëspine, Airway, Breathing, Circulation.</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>Medical:</strong> A‚ÄëB‚ÄëC ‚Äì Airway, Breathing, Circulation ‚Üí Disability, Exposure.</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>Cardiac arrest:</strong> C‚ÄëA‚ÄëB ‚Äì Compressions, Airway, Breathing.</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>Airway:</strong> Open with head‚Äëtilt/chin‚Äëlift or jaw thrust (if trauma). Suction, OPA/NPA, supraglottic/ETT as indicated.</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>Breathing:</strong> Rate, effort, SpO‚ÇÇ, breath sounds. O‚ÇÇ to target SpO‚ÇÇ 94‚Äë98% (88‚Äë92% COPD). BVM if inadequate.</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>Circulation:</strong> Control major haemorrhage (tourniquet, hemostatic agents). Palpate pulse (carotid ‚Äì unconscious adult; brachial ‚Äì infant). Assess skin, CRT (<2 sec normal).</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>Disability:</strong> AVPU (Alert, Voice, Pain, Unresponsive). GCS (3‚Äë15). Check blood glucose; if <70 mg/dl ‚Üí Hypoglycaemia CPG. BEFAST if stroke suspected.</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>Exposure:</strong> Remove clothing as needed; maintain modesty and temperature.</li>
        </ul>

        <h4 style="color:#004e92; margin:20px 0 10px;">3. ALS BACKUP</h4>
        <ul style="list-style-type: none; padding-left:0;">
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> Request within <strong>5 minutes</strong> if advanced skills needed.</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>Red priority (unstable):</strong> always request ALS.</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>Stable red priority:</strong> e.g. controlled limb bleed, uncomplicated CVA ‚Äì ALS may be deferred if transport <10 min.</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> May request and rendezvous en route.</li>
        </ul>

        <h4 style="color:#004e92; margin:20px 0 10px;">4. VITAL SIGNS & MONITORING</h4>
        <ul style="list-style-type: none; padding-left:0;">
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> Obtain full set: HR, BP, RR, SpO‚ÇÇ, temperature, BGL (if indicated), EtCO‚ÇÇ (if indicated), neurologic status.</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>Normal ranges (adult):</strong> HR 60‚Äë100, RR 12‚Äë20, SBP ‚â•90, SpO‚ÇÇ ‚â•94%, EtCO‚ÇÇ 35‚Äë45.</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>Paediatric norms:</strong> use age‚Äëspecific charts (see CPG 1.1 table).</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>Hypotension:</strong> SBP <90 mmHg (adult) or <5th percentile for age (paeds).</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>Tachycardia:</strong> HR >100 (adult); Bradycardia: HR <60 (adult).</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>12‚Äëlead ECG:</strong> for cardiac or suspected cardiac complaints. Continuous monitoring for unstable patients.</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>Waveform capnography:</strong> essential for advanced airways and critical patients.</li>
        </ul>

        <h4 style="color:#004e92; margin:20px 0 10px;">5. SECONDARY SURVEY & HISTORY</h4>
        <ul style="list-style-type: none; padding-left:0;">
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>Physical exam:</strong> head‚Äëto‚Äëtoe (trauma: DCAP‚ÄëBTLS‚ÄëTIC; medical: system‚Äëfocused).</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>OPQRST:</strong> Onset, Provocation, Quality, Radiation, Severity, Time.</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>SAMPLE:</strong> Signs/symptoms, Allergies, Medications, Past history, Last oral intake, Events.</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>Pain assessment:</strong> 0‚Äë10 scale, Wong‚ÄëBaker (non‚Äëverbal), FLACC (paeds <3 yrs).</li>
        </ul>

        <h4 style="color:#004e92; margin:20px 0 10px;">6. RED FLAGS (IMMEDIATE LIFE THREATS)</h4>
        <div style="background:#f8d7da; padding:15px; border-radius:12px; margin:10px 0;">
            <ul style="margin:0; color:#721c24;">
                <li>Apnoea, pulselessness, severe haemorrhage</li>
                <li>Altered mental status (AVPU < A, GCS ‚â§8 or deteriorating)</li>
                <li>Hypoxia (SpO‚ÇÇ <90% on O‚ÇÇ) / hypotension (SBP <90)</li>
                <li>High‚Äërisk MOI: fall >10ft, high‚Äëspeed MVC, ejection, death in same vehicle, pedestrian vs vehicle</li>
                <li>Signs of severe shock, STEMI, uncontrolled dysrhythmia</li>
            </ul>
        </div>

        <h4 style="color:#004e92; margin:20px 0 10px;">7. VASCULAR ACCESS & FLUIDS</h4>
        <ul style="list-style-type: none; padding-left:0;">
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> IV access if deterioration risk, fluid/medication need. IO if IV fails.</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> Crystalloid (Normal Saline / Ringer's Lactate) for hypotension/shock. Adult: 250‚Äë500 mL bolus, reassess; max 2000 mL. Paeds: 20 mL/kg, max 60 mL/kg.</li>
        </ul>

        <h4 style="color:#004e92; margin:20px 0 10px;">8. REASSESSMENT INTERVALS</h4>
        <ul style="list-style-type: none; padding-left:0;">
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <span style="background:#ffcccc; padding:3px 8px; border-radius:20px;">üî¥ Red (critical):</span> every <strong>5 minutes</strong></li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <span style="background:#fff3cd; padding:3px 8px; border-radius:20px;">üü° Yellow (serious):</span> every <strong>10 minutes</strong></li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <span style="background:#d4edda; padding:3px 8px; border-radius:20px;">üü¢ Green (stable):</span> every <strong>15 minutes</strong></li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> Reassess LOC, airway, breathing, circulation, vitals, interventions, response.</li>
        </ul>

        <h4 style="color:#004e92; margin:20px 0 10px;">9. TELE‚ÄëEMS CONSULTATION</h4>
        <ul style="list-style-type: none; padding-left:0;">
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> For complex cases, skill outside scope, or 12‚Äëlead interpretation.</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> Not mandatory for every case; do not delay essential interventions.</li>
        </ul>

        <h4 style="color:#004e92; margin:20px 0 10px;">10. PATIENT HANDOVER (IMIST‚ÄëAMBO)</h4>
        <ul style="list-style-type: none; padding-left:0;">
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>I</strong> ‚Äì Identification</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>M</strong> ‚Äì Mechanism/Medical complaint</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>I</strong> ‚Äì Injuries/Information</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>S</strong> ‚Äì Signs (vitals)</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>T</strong> ‚Äì Treatment</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>A</strong> ‚Äì Allergies</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>M</strong> ‚Äì Medications</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>B</strong> ‚Äì Background</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>O</strong> ‚Äì Other info</li>
        </ul>

        <h4 style="color:#004e92; margin:20px 0 10px;">11. DOCUMENTATION (ePCR)</h4>
        <ul style="list-style-type: none; padding-left:0;">
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> Must include: identification, MOI/medical complaint, injuries, signs, treatment, allergies, medications, background, other.</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> Timestamps for all critical events and reassessments.</li>
        </ul>

        <h4 style="color:#004e92; margin:20px 0 10px;">12. SPECIAL POPULATIONS</h4>
        <ul style="list-style-type: none; padding-left:0;">
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>Paediatrics:</strong> ‚â§13 years. Use Broselow tape for weight/meds. PAT = Appearance, Work of Breathing, Circulation to skin.</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>Geriatrics:</strong> ‚â•65 years. Reduced doses for renal/hepatic impairment. Higher risk of under‚Äëtriage.</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>Comorbidities:</strong> adjust medication doses for renal/hepatic disease.</li>
        </ul>

        <h4 style="color:#004e92; margin:20px 0 10px;">13. AIRWING CONSIDERATIONS</h4>
        <ul style="list-style-type: none; padding-left:0;">
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> For time‚Äëcritical patients with ground transport >30 min.</li>
            <li style="margin-bottom:8px;"><span style="background:#004e92; color:white; padding:2px 10px; border-radius:20px;">‚Ä¢</span> <strong>Exclusions:</strong> imminent birth, violent patients.</li>
        </ul>
    </div>
    <div class="sum-card red-flag">
        <h3 style="color:#dc3545; margin-bottom:15px;">üö® CRITICAL RED FLAGS ‚Äì IMMEDIATE ACTION</h3>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:15px;">
            <span style="background:#f8d7da; padding:5px 12px; border-radius:20px; font-weight:600;">Apnoea / pulseless</span>
            <span style="background:#f8d7da; padding:5px 12px; border-radius:20px; font-weight:600;">GCS ‚â§8 or ‚Üì</span>
            <span style="background:#f8d7da; padding:5px 12px; border-radius:20px; font-weight:600;">SpO‚ÇÇ <90%</span>
            <span style="background:#f8d7da; padding:5px 12px; border-radius:20px; font-weight:600;">SBP <90</span>
            <span style="background:#f8d7da; padding:5px 12px; border-radius:20px; font-weight:600;">Uncontrolled haemorrhage</span>
            <span style="background:#f8d7da; padding:5px 12px; border-radius:20px; font-weight:600;">STEMI / dysrhythmia + shock</span>
            <span style="background:#f8d7da; padding:5px 12px; border-radius:20px; font-weight:600;">Significant MOI</span>
        </div>
        <div class="highlight-box" style="margin-top:10px; background:#fff3cd; border-left-color:#856404;">
            <strong>üéØ KPI:</strong> ALS backup requested within 1 minute of red flag identification.
        </div>
    </div>
`;
        // ---------- 60 QUIZ QUESTIONS ‚Äì UNIVERSAL CARE 1.1 ----------
        const quizBank = [
            // 1-10 (existing, renumbered)
            { q: "What is the correct assessment sequence for a Trauma patient?", options: ["A-B-C-D-E", "C-A-B-C", "D-R-A-B-C", "M-A-R-C-H"], correct: 1, explanation: "C‚ÄëA‚ÄëB‚ÄëC: Catastrophic Haemorrhage/C‚Äëspine, Airway, Breathing, Circulation." },
            { q: "What is the assessment sequence for a Medical patient?", options: ["A-B-C-D-E", "C-A-B-C", "D-R-A-B-C", "Safety-First"], correct: 0, explanation: "Medical patients follow A‚ÄëB‚ÄëC: Airway, Breathing, Circulation, Disability, Exposure." },
            { q: "What is the assessment sequence for Cardiac Arrest?", options: ["A-B-C", "C-A-B", "D-R-A-B-C", "B-A-C"], correct: 1, explanation: "Cardiac arrest: C‚ÄëA‚ÄëB (Compressions, Airway, Breathing)." },
            { q: "What are the 3 elements of the 'General Impression'?", options: ["Airway, Breathing, Circ", "Appearance, Breathing, Activity", "Alertness, Bleeding, Color", "Age, Body type, Complaint"], correct: 1, explanation: "Appearance, Work of Breathing, Activity (mental status)." },
            { q: "In the AVPU scale, what does 'P' stand for?", options: ["Pulse", "Pain", "Pupils", "Pallor"], correct: 1, explanation: "Pain ‚Äì responds to painful stimuli." },
            { q: "Where do you check the pulse on an unconscious adult?", options: ["Radial", "Carotid", "Femoral", "Brachial"], correct: 1, explanation: "Carotid artery is the central pulse." },
            { q: "Where do you check the pulse on an infant (<1 year)?", options: ["Carotid", "Brachial", "Radial", "Popliteal"], correct: 1, explanation: "Brachial pulse is recommended." },
            { q: "Normal capillary refill time (CRT) is less than:", options: ["1 second", "2 seconds", "3 seconds", "5 seconds"], correct: 1, explanation: "CRT <2 seconds is normal." },
            { q: "What is the absolute FIRST step in any call?", options: ["Airway", "Scene Safety", "Circulation", "Call Dispatch"], correct: 1, explanation: "Scene safety always first." },
            { q: "What does 'D' stand for in ABCDE?", options: ["Deformity", "Disability", "Danger", "Disease"], correct: 1, explanation: "Disability ‚Äì rapid neuro check." },
            // 11-20 (existing)
            { q: "What is the target SpO‚ÇÇ for a COPD patient?", options: ["100%", "94-98%", "88-92%", ">95%"], correct: 2, explanation: "88‚Äë92% to avoid suppressing hypoxic drive." },
            { q: "Hypotension in an adult is defined as SBP below:", options: ["110 mmHg", "100 mmHg", "90 mmHg", "80 mmHg"], correct: 2, explanation: "SBP <90 mmHg = hypotension." },
            { q: "You initiate hypoglycaemia treatment if BGL is below:", options: ["80 mg/dl", "70 mg/dl", "60 mg/dl", "100 mg/dl"], correct: 1, explanation: "Treat if BGL <70 mg/dl and symptomatic." },
            { q: "What does EtCO‚ÇÇ monitoring measure?", options: ["Oxygen in blood", "Carbon dioxide exhaled", "Carbon monoxide", "pH balance"], correct: 1, explanation: "End‚Äëtidal CO‚ÇÇ ‚Äì gold standard for tube placement and CPR quality." },
            { q: "Normal EtCO‚ÇÇ range is:", options: ["20-30 mmHg", "35-45 mmHg", "45-55 mmHg", "90-100 mmHg"], correct: 1, explanation: "35‚Äë45 mmHg is normal." },
            { q: "How often do you reassess a 'Red' (Critical) patient?", options: ["5 min", "10 min", "15 min", "Continuous"], correct: 0, explanation: "Every 5 minutes." },
            { q: "How often do you reassess a 'Green' (Non‚ÄëCritical) patient?", options: ["5 min", "10 min", "15 min", "30 min"], correct: 2, explanation: "Every 15 minutes." },
            { q: "In SAMPLE history, what does 'L' stand for?", options: ["Last oral intake", "Last menstrual period", "Level of consciousness", "Location"], correct: 0, explanation: "Last oral intake." },
            { q: "In OPQRST, what does 'P' stand for?", options: ["Past History", "Provocation/Palliation", "Pain Score", "Pulse"], correct: 1, explanation: "Provocation/Palliation ‚Äì what makes it better/worse." },
            { q: "Which mnemonic is used for Stroke Assessment?", options: ["SAMPLE", "BEFAST", "OPQRST", "AEIOU"], correct: 1, explanation: "BEFAST: Balance, Eyes, Face, Arms, Speech, Time." },
            // 21-30 ‚Äì Vitals & normal ranges
            { q: "What is the normal heart rate for an adult at rest?", options: ["50-90 bpm", "60-100 bpm", "70-110 bpm", "80-120 bpm"], correct: 1, explanation: "60‚Äë100 bpm is the standard range." },
            { q: "What is the normal respiratory rate for an adult?", options: ["8-12/min", "12-20/min", "16-24/min", "20-30/min"], correct: 1, explanation: "12‚Äë20 breaths/min." },
            { q: "What is the definition of bradycardia in an adult?", options: ["<50 bpm", "<60 bpm", "<70 bpm", "<80 bpm"], correct: 1, explanation: "Heart rate <60 bpm." },
            { q: "What is the definition of tachycardia in an adult?", options: [">90 bpm", ">100 bpm", ">110 bpm", ">120 bpm"], correct: 1, explanation: "Heart rate >100 bpm." },
            { q: "What is the normal systolic BP for a newborn (0-1 month)?", options: ["39-59 mmHg", "60-76 mmHg", "67-84 mmHg", "72-104 mmHg"], correct: 1, explanation: "Newborn SBP range 60‚Äë76 mmHg (from CPG table)." },
            { q: "What is the normal systolic BP for a child 6-10 years?", options: ["89-112 mmHg", "97-115 mmHg", "102-120 mmHg", "110-131 mmHg"], correct: 1, explanation: "97‚Äë115 mmHg." },
            { q: "What is the target SpO‚ÇÇ for a standard medical patient?", options: ["90-94%", "94-98%", "98-100%", "88-92%"], correct: 1, explanation: "Aim for 94‚Äë98%." },
            { q: "What does 'C' stand for in the trauma C‚ÄëABC approach?", options: ["Circulation", "C‚Äëspine control", "Catastrophic haemorrhage", "Chest compressions"], correct: 2, explanation: "C = Catastrophic haemorrhage (bleeding control)." },
            { q: "What is the Glasgow Coma Scale (GCS) range?", options: ["1-10", "3-15", "0-14", "5-20"], correct: 1, explanation: "GCS ranges from 3 (deep coma) to 15 (fully alert)." },
            { q: "What is the verbal response score for 'Confused' in adults?", options: ["5", "4", "3", "2"], correct: 1, explanation: "Confused = 4." },
            // 31-40 ‚Äì Mnemonics & history
            { q: "In DCAP‚ÄëBTLS, what does 'B' stand for?", options: ["Bleeding", "Burns", "Bruising", "Breath sounds"], correct: 1, explanation: "B = Burns." },
            { q: "In SAMPLE history, what does 'A' stand for?", options: ["Age", "Allergies", "Appearance", "Airway"], correct: 1, explanation: "Allergies." },
            { q: "In OPQRST, what does 'R' stand for?", options: ["Rate", "Rhythm", "Radiation", "Reaction"], correct: 2, explanation: "Radiation ‚Äì does the pain move?" },
            { q: "In IMIST‚ÄëAMBO, what does 'I' stand for?", options: ["Injuries", "Identification", "Illness", "Intake"], correct: 1, explanation: "Identification of patient." },
            { q: "In IMIST‚ÄëAMBO, what does 'S' stand for?", options: ["Symptoms", "Signs", "Severity", "Scene"], correct: 1, explanation: "Signs (vital signs)." },
            { q: "What does 'AEIOU‚ÄëTIPS' help assess?", options: ["Chest pain", "Altered mental status", "Trauma triage", "Respiratory distress"], correct: 1, explanation: "AEIOU‚ÄëTIPS is a mnemonic for causes of altered mental status." },
            { q: "What does 'PASTE' assess?", options: ["Respiratory distress", "Cardiac chest pain", "Stroke", "Abdominal pain"], correct: 0, explanation: "PASTE is a respiratory assessment mnemonic (Provocation, Associated chest pain, Sputum, Talking tiredness, Exacerbation)." },
            { q: "What is the APGAR score component for 'Appearance'?", options: ["Color", "Pulse", "Grimace", "Activity"], correct: 0, explanation: "Appearance assesses skin color." },
            { q: "What is the normal APGAR score range?", options: ["0-5", "0-10", "1-8", "5-15"], correct: 1, explanation: "APGAR score 0‚Äë10; 7‚Äë10 is reassuring." },
            { q: "In SLUDGE, what does 'U' stand for?", options: ["Urination", "Unresponsiveness", "Uremia", "Ulcers"], correct: 0, explanation: "SLUDGE: Salivation, Lacrimation, Urination, Defecation, GI upset, Emesis ‚Äì cholinergic toxidrome." },
            // 41-50 ‚Äì CPR & ALS
            { q: "What is the adult CPR compression:ventilation ratio (single rescuer)?", options: ["15:2", "30:2", "20:2", "10:1"], correct: 1, explanation: "30:2 for all adults." },
            { q: "What is the pediatric CPR ratio for two rescuers?", options: ["30:2", "15:2", "20:2", "5:1"], correct: 1, explanation: "15:2 for children/infants (two rescuers)." },
            { q: "What is the recommended compression rate for CPR?", options: ["80-100/min", "100-120/min", "120-140/min", "90-110/min"], correct: 1, explanation: "100‚Äë120 compressions per minute." },
            { q: "What is the correct compression depth for an adult?", options: ["At least 2 cm", "At least 5 cm", "3-4 cm", "6-7 cm"], correct: 1, explanation: "At least 5 cm (2 inches), no more than 6 cm." },
            { q: "How often should you switch compressors during CPR?", options: ["Every 1 min", "Every 2 mins", "Every 5 mins", "When tired"], correct: 1, explanation: "Switch every 2 minutes to prevent fatigue." },
            { q: "What is the maximum interruption time for pulses/breaths during CPR?", options: ["5 sec", "10 sec", "15 sec", "20 sec"], correct: 1, explanation: "Interruptions <10 seconds." },
            { q: "Where is the correct hand placement for adult CPR?", options: ["Upper half of sternum", "Lower half of sternum", "Left side of chest", "Right side of chest"], correct: 1, explanation: "Lower half of the sternum." },
            { q: "With an advanced airway in place, how often do you ventilate during CPR?", options: ["1 breath every 3 sec", "1 breath every 6 sec", "1 breath every 10 sec", "Asynchronous with compressions"], correct: 1, explanation: "1 breath every 6 seconds (10 breaths/min) without pausing compressions." },
            { q: "What is the first drug for non‚Äëshockable cardiac arrest?", options: ["Amiodarone", "Atropine", "Adrenaline (Epinephrine)", "Lidocaine"], correct: 2, explanation: "Adrenaline 1 mg IV/IO every 3‚Äë5 minutes." },
            { q: "What is the standard energy for first biphasic defibrillation?", options: ["100J", "120‚Äë200J", "360J", "50J"], correct: 1, explanation: "Manufacturer‚Äëspecific, typically 120‚Äë200J." },
            // 51-60 ‚Äì Operations & Paediatrics
            { q: "What is the safe parking distance from a burning vehicle?", options: ["15m", "30m", "50m", "100m"], correct: 2, explanation: "At least 30‚Äë50m, uphill and upwind." },
            { q: "In HazMat, which zone is the 'Hot Zone'?", options: ["Support zone", "Contamination zone", "Safe zone", "Decon zone"], correct: 1, explanation: "Hot = contamination zone." },
            { q: "Is imminent birth an exclusion for Airwing transport?", options: ["True", "False"], correct: 0, explanation: "True ‚Äì delivering in helicopter is dangerous." },
            { q: "Are violent patients eligible for Airwing?", options: ["True", "False"], correct: 1, explanation: "False ‚Äì safety risk." },
            { q: "What PPE is required for Standard Precautions?", options: ["Gloves only", "Gloves & Glasses", "Gloves, Mask, Glasses, Gown (risk‚Äëbased)", "Mask only"], correct: 2, explanation: "Risk‚Äëbased PPE: gloves, mask, eye protection, gown." },
            { q: "When lifting, you should primarily use your:", options: ["Back", "Legs/Hips", "Arms", "Shoulders"], correct: 1, explanation: "Lift with legs, keep back straight." },
            { q: "When is a tourniquet indicated?", options: ["Minor cuts", "Venous bleeding", "Uncontrolled arterial limb bleed", "Head wounds"], correct: 2, explanation: "Life‚Äëthreatening arterial haemorrhage on a limb." },
            { q: "What is the 'Golden Hour' in trauma?", options: ["Time to eat", "Time from injury to surgery", "Time on scene", "Time to call dispatch"], correct: 1, explanation: "Window from injury to definitive care (approx 60 min)." },
            { q: "The Pediatric Assessment Triangle (PAT) consists of Appearance, Circulation, and:", options: ["Airway", "Work of Breathing", "Bleeding", "Alertness"], correct: 1, explanation: "PAT = Appearance, Work of Breathing, Circulation to Skin." },
            { q: "In Dubai CPGs, a pediatric patient is defined as age:", options: ["<12", "‚â§13", "<16", "<18"], correct: 1, explanation: "13 years and under." }
        ];

        // ---------- 60 FLASHCARDS ‚Äì UNIVERSAL CARE 1.1 ----------
        const flashDeck = [
            // 1-10 (existing)
            { category: "Primary Survey", question: "Trauma assessment sequence?", answer: "C‚ÄëA‚ÄëB‚ÄëC\n1. Catastrophic Haemorrhage / C‚Äëspine\n2. Airway\n3. Breathing\n4. Circulation" },
            { category: "Primary Survey", question: "Medical patient assessment?", answer: "A‚ÄëB‚ÄëC\nAirway ‚Üí Breathing ‚Üí Circulation\nThen Disability & Exposure" },
            { category: "Primary Survey", question: "Cardiac arrest sequence?", answer: "C‚ÄëA‚ÄëB\nCompressions ‚Üí Airway ‚Üí Breathing" },
            { category: "Primary Survey", question: "General Impression elements?", answer: "1. Appearance\n2. Work of Breathing\n3. Circulation to skin" },
            { category: "AVPU", question: "What does AVPU stand for?", answer: "Alert, Verbal, Pain, Unresponsive" },
            { category: "Vitals", question: "Normal adult pulse?", answer: "60‚Äë100 bpm" },
            { category: "Vitals", question: "Normal adult respiratory rate?", answer: "12‚Äë20 breaths/min" },
            { category: "Vitals", question: "Normal CRT?", answer: "< 2 seconds" },
            { category: "Vitals", question: "SpO‚ÇÇ target (standard)?", answer: ">94% (94‚Äë98%)" },
            { category: "Vitals", question: "SpO‚ÇÇ target (COPD)?", answer: "88‚Äë92%" },
            // 11-20 (existing)
            { category: "Shock", question: "Hypotension threshold?", answer: "SBP <90 mmHg" },
            { category: "Hypoglycaemia", question: "Treat BGL below?", answer: "<70 mg/dl" },
            { category: "Monitoring", question: "EtCO‚ÇÇ normal range?", answer: "35‚Äë45 mmHg" },
            { category: "Reassessment", question: "Red priority interval?", answer: "Every 5 minutes" },
            { category: "Reassessment", question: "Green priority interval?", answer: "Every 15 minutes" },
            { category: "Mnemonics", question: "DCAP‚ÄëBTLS ‚Äì what does S stand for?", answer: "Swelling" },
            { category: "Mnemonics", question: "SAMPLE ‚Äì what does L stand for?", answer: "Last oral intake" },
            { category: "Mnemonics", question: "OPQRST ‚Äì what does R stand for?", answer: "Radiation" },
            { category: "Handover", question: "IMIST‚ÄëAMBO ‚Äì what does A stand for?", answer: "Allergies" },
            { category: "Handover", question: "IMIST‚ÄëAMBO ‚Äì what does M stand for?", answer: "Medications" },
            // 21-30 ‚Äì more mnemonics & GCS
            { category: "Stroke", question: "BEFAST ‚Äì what does B stand for?", answer: "Balance" },
            { category: "GCS", question: "Confused verbal response score?", answer: "4" },
            { category: "GCS", question: "Spontaneous eye opening score?", answer: "4" },
            { category: "Safety", question: "First priority on every call?", answer: "Scene safety" },
            { category: "Operations", question: "Standard precautions PPE?", answer: "Gloves, mask, eye protection, gown (risk‚Äëbased)" },
            { category: "Airway", question: "Pulse check in infant?", answer: "Brachial artery" },
            { category: "Airway", question: "Pulse check in unconscious adult?", answer: "Carotid artery" },
            { category: "Triage", question: "Yellow priority reassessment interval?", answer: "Every 10 minutes" },
            { category: "History", question: "OPQRST ‚Äì what does O stand for?", answer: "Onset" },
            { category: "History", question: "SAMPLE ‚Äì what does E stand for?", answer: "Events leading up" },
            // 31-40 ‚Äì Vitals by age
            { category: "Vitals", question: "Newborn heart rate (awake)?", answer: "100‚Äë205 bpm" },
            { category: "Vitals", question: "Infant (1-12 mo) heart rate?", answer: "100‚Äë180 bpm" },
            { category: "Vitals", question: "Child 1-3 years heart rate?", answer: "100‚Äë140 bpm" },
            { category: "Vitals", question: "Child 6-10 years heart rate?", answer: "75‚Äë120 bpm" },
            { category: "Vitals", question: "Adolescent heart rate?", answer: "60‚Äë100 bpm" },
            { category: "Vitals", question: "Newborn SBP range?", answer: "60‚Äë76 mmHg" },
            { category: "Vitals", question: "Child 1-2 years SBP?", answer: "86‚Äë106 mmHg" },
            { category: "Vitals", question: "Child 6-10 years SBP?", answer: "97‚Äë115 mmHg" },
            { category: "Vitals", question: "Adult SBP normal range?", answer: "90‚Äë120 mmHg (approx)" },
            { category: "Vitals", question: "Bradycardia definition (adult)?", answer: "HR <60 bpm" },
            // 41-50 ‚Äì Trauma & operations
            { category: "Trauma", question: "Significant MOI ‚Äì fall height?", answer: ">10 feet (all ages)" },
            { category: "Trauma", question: "Tourniquet application time?", answer: "Mark time; do not remove until hospital" },
            { category: "Trauma", question: "Pelvic binder indication?", answer: "Unstable pelvic fracture / suspected haemorrhage" },
            { category: "Trauma", question: "Chest seal indication?", answer: "Open / sucking chest wound" },
            { category: "CPR", question: "Adult compression depth?", answer: "5‚Äë6 cm (2‚Äë2.4 inches)" },
            { category: "CPR", question: "Infant compression depth?", answer: "4 cm (1.5 inches) or 1/3 chest depth" },
            { category: "CPR", question: "Ventilation rate with advanced airway?", answer: "1 breath every 6 seconds (10/min)" },
            { category: "CPR", question: "Shockable rhythms?", answer: "VF, pulseless VT" },
            { category: "CPR", question: "Non‚Äëshockable rhythms?", answer: "Asystole, PEA" },
            { category: "ALS", question: "When to request ALS backup?", answer: "Within 5 min if red flags or unstable" },
            // 51-60 ‚Äì Paediatrics & special
            { category: "Paediatrics", question: "Pediatric age cutoff in Dubai?", answer: "13 years and under" },
            { category: "Paediatrics", question: "Pediatric Assessment Triangle (PAT)?", answer: "Appearance, Work of Breathing, Circulation to Skin" },
            { category: "Paediatrics", question: "Late sign of shock in children?", answer: "Hypotension (decompensated shock)" },
            { category: "Paediatrics", question: "Neonatal pulse check site?", answer: "Brachial / apical" },
            { category: "Burns", question: "Rule of Nines ‚Äì adult arm?", answer: "9% TBSA" },
            { category: "Burns", question: "Rule of Nines ‚Äì adult leg?", answer: "18% TBSA" },
            { category: "Burns", question: "Rule of Nines ‚Äì adult anterior torso?", answer: "18% (chest 9% + abdomen 9%)" },
            { category: "Positioning", question: "Shock patient (no spinal injury) position?", answer: "Supine (flat on back)" },
            { category: "Positioning", question: "Recovery position indication?", answer: "Unconscious, breathing, pulse present" },
            { category: "Oxygen", question: "Flow rate for Non‚ÄëRebreather Mask?", answer: "10‚Äë15 L/min" }
        ];

        // ---------- CRITICAL SCENARIOS (5 cases ‚Äì unchanged) ----------
        const criticalScenarios = [
            { 
                id: "crit1", 
                scenario: "You arrive at a factory. A 45‚Äëyear‚Äëold male has a metal rod impaled in his left thigh. There is active arterial bleeding. He is conscious, pale, and sweating. HR 125, BP 95/60, RR 22, SpO‚ÇÇ 97%.", 
                question: "What is your FIRST intervention?", 
                options: ["Remove the rod to pack the wound", "Apply a tourniquet proximal to the injury", "Apply direct pressure around the rod", "Start IV fluids"], 
                correct: 1, 
                explanation: "Uncontrolled arterial limb bleeding = tourniquet indication. Do not remove impaled objects ‚Äì they may tamponade bleeding.", 
                kpi: "Tourniquet applied within 1 minute" 
            },
            { 
                id: "crit2", 
                scenario: "A 68‚Äëyear‚Äëold female with history of COPD presents with severe shortness of breath. She is using accessory muscles, SpO‚ÇÇ 84% on room air. Respiratory rate 32, HR 115. She has audible wheeze.", 
                question: "What is the target SpO‚ÇÇ range for this patient?", 
                options: ["94‚Äë98%", "88‚Äë92%", "100%", ">95%"], 
                correct: 1, 
                explanation: "COPD patients require 88‚Äë92% SpO‚ÇÇ to avoid suppressing hypoxic drive.", 
                kpi: "O‚ÇÇ titrated to 88‚Äë92%" 
            },
            { 
                id: "crit3", 
                scenario: "You are called to a motor vehicle collision. The driver is unresponsive, breathing agonal, no palpable carotid pulse. Mechanism suggests blunt trauma.", 
                question: "What is the correct sequence of interventions?", 
                options: ["A-B-C", "C-A-B-C", "C-A-B", "D-R-A-B-C"], 
                correct: 1, 
                explanation: "Trauma cardiac arrest ‚Üí C‚ÄëA‚ÄëB‚ÄëC: catastrophic haemorrhage control, airway, breathing, circulation.", 
                kpi: "C‚Äëspine manual stabilisation & bleeding check before airway" 
            },
            { 
                id: "crit4", 
                scenario: "A 7‚Äëyear‚Äëold child is found unresponsive after a fall from a tree. He has a GCS of 6, shallow breathing at 8/min, and a weak carotid pulse. Blood glucose is 45 mg/dl.", 
                question: "What is the priority intervention?", 
                options: ["Start chest compressions", "Administer IV dextrose", "Open airway and assist ventilation", "Apply c‚Äëcollar"], 
                correct: 2, 
                explanation: "Paediatric bradycardia is usually hypoxic ‚Äì open airway and ventilate first. Hypoglycaemia must be treated but does not supersede airway/breathing.", 
                kpi: "BVM ventilation initiated within 1 minute" 
            },
            { 
                id: "crit5", 
                scenario: "A 30‚Äëyear‚Äëold female, 32 weeks pregnant, complains of sudden severe headache and blurred vision. BP is 175/110, HR 95. She is agitated.", 
                question: "What is the most appropriate initial management?", 
                options: ["Immediate transport supine", "Left lateral position, oxygen, and antihypertensive", "12‚Äëlead ECG", "IV fluid bolus"], 
                correct: 1, 
                explanation: "Severe pre‚Äëeclampsia: left lateral tilt, high‚Äëflow O‚ÇÇ, and consider labetalol (if severe hypertension persists).", 
                kpi: "Uterine displacement and BP control" 
            }
        ];

        return {
            chapters: [
                {
                    id: chapterId,
                    title: chapterTitle,
                    shortTitle: shortTitle,
                    summary: summaryHTML,
                    quiz: quizBank,
                    flashcards: flashDeck,
                    critical: criticalScenarios
                }
            ],
            getChapter: function(id) {
                return this.chapters.find(ch => ch.id === id) || null;
            }
        };
    })();
</script>
<!-- ========== APP.JS ‚Äì COMPLETE LOGIC LAYER (IIFE, ROUTER, STATE, ENGINE) ========== -->
<script>
    (function(){
        "use strict";

        // ---------- SAFE STORAGE WRAPPER ----------
        const storage = (function() {
            const KEY = 'dcas_cpg_stats';
            const defaultStats = {
                totalAttempts: 0,
                chapters: {},
                critical: { total: 0, correct: 0 }
            };
            function load() {
                try {
                    const data = localStorage.getItem(KEY);
                    return data ? JSON.parse(data) : defaultStats;
                } catch(e) {
                    return defaultStats;
                }
            }
            function save(stats) {
                try {
                    localStorage.setItem(KEY, JSON.stringify(stats));
                } catch(e) { /* ignore */ }
            }
            return { load, save };
        })();

        // ---------- CENTRAL STATE ----------
        const state = {
            activeChapter: null,
            quizData: [],          // current quiz pool (shuffled)
            mistakes: [],         // { question, correctAnswer, rationale }
            qIndex: 0,
            score: 0,
            flashData: [],
            fIndex: 0,
            criticalData: [],
            criticalIndex: 0,
            criticalScore: 0,
            stats: storage.load()
        };

        // ---------- DOM ELEMENT REFERENCES (cached) ----------
        const dom = {
            main: document.getElementById('mainContent'),
            homeBtn: document.getElementById('homeBtn'),
            pageTitle: document.getElementById('pageTitle'),
            pageSubtitle: document.getElementById('pageSubtitle')
        };

        // ---------- UTILITIES ----------
        const utils = {
            shuffle: (arr) => [...arr].sort(() => Math.random() - 0.5),
            safeScrollTop: () => {
                window.scrollTo(0,0);
                document.body.scrollTop = 0;
                document.documentElement.scrollTop = 0;
                setTimeout(() => window.scrollTo(0,0), 20);
            },
            escapeHTML: (str) => str.replace(/[&<>"]/g, function(c) {
                if(c === '&') return '&amp;';
                if(c === '<') return '&lt;';
                if(c === '>') return '&gt;';
                if(c === '"') return '&quot;';
                return c;
            }),
            getChapter: (id) => CPG_CONTENT.getChapter(id)
        };

        // ---------- HEADER CONTROLLER ----------
        function updateHeader(title, subtitle = '', showBack = true) {
            dom.pageTitle.innerText = title || 'DCAS CPG 2025';
            dom.pageSubtitle.innerText = subtitle || '';
            dom.homeBtn.style.display = showBack ? 'block' : 'none';
        }

        // ---------- RENDER FUNCTIONS (each view) ----------
        const render = {
            home: function() {
                const chapter = CPG_CONTENT.chapters[0]; // only 1.1 for now
                const html = `
                    <div class="menu-grid">
                        <div class="menu-card update-card">
                            <span class="status-badge">Active</span>
                            <h2>${chapter.shortTitle}</h2>
                            <p>${chapter.title} ¬∑ Scene safety, ABCDE, triage, vitals.</p>
                            <div class="menu-sub-options" style="display:flex; gap:10px; flex-wrap:wrap;">
                                <button class="btn-action btn-summary" data-action="summary" data-chapter="${chapter.id}">üìò Summary</button>
                                <button class="btn-action btn-flash" data-action="flashcards" data-chapter="${chapter.id}">üìá Flashcards</button>
                                <button class="btn-action btn-quiz" data-action="quiz" data-chapter="${chapter.id}">üìã Quiz</button>
                                <button class="btn-action btn-critical" data-action="critical" data-chapter="${chapter.id}">üö® Critical</button>
                            </div>
                        </div>
                        <div class="menu-card">
                            <span class="status-badge">Stats</span>
                            <h2>Performance</h2>
                            <p>Attempts: ${state.stats.totalAttempts || 0} | Critical accuracy: ${state.stats.critical.total ? Math.round((state.stats.critical.correct/state.stats.critical.total)*100) : 0}%</p>
                            <div style="margin-top:10px;">
                                <button class="btn-action" data-action="stats">üìä View Stats</button>
                                ${state.mistakes.length ? '<button class="btn-action" data-action="reviewMistakes">üìù Review Mistakes</button>' : ''}
                            </div>
                        </div>
                    </div>
                `;
                dom.main.innerHTML = html;
                updateHeader('DCAS CPG 2025', 'Universal Care ¬∑ 1.1', false);
                utils.safeScrollTop();
            },

            summary: function(chapterId) {
                const chapter = utils.getChapter(chapterId);
                if (!chapter) { router.navigate('home'); return; }
                dom.main.innerHTML = `<div class="section active">${chapter.summary}<button class="control-btn" data-action="backHome" style="width:100%; margin-top:20px;">‚Üê Back</button></div>`;
                updateHeader(chapter.shortTitle, 'Summary', true);
                utils.safeScrollTop();
            },

            flashcards: function(chapterId) {
                const chapter = utils.getChapter(chapterId);
                if (!chapter) { router.navigate('home'); return; }
                state.flashData = chapter.flashcards;
                state.fIndex = 0;
                this._renderFlashcard();
                updateHeader(chapter.shortTitle, 'Flashcards', true);
            },

            _renderFlashcard: function() {
                if (!state.flashData.length) return;
                const card = state.flashData[state.fIndex];
                const html = `
                    <div style="text-align: center; color: rgba(255,255,255,0.8); margin-bottom: 15px;" id="fc-progress">Card ${state.fIndex+1} of ${state.flashData.length}</div>
                    <div class="scene" id="cardScene">
                        <div class="card" id="flashcard">
                            <div class="card__face card__face--front">
                                <span class="category-badge">${utils.escapeHTML(card.category)}</span>
                                <div style="white-space: pre-wrap; font-size:1.3rem;">${utils.escapeHTML(card.question)}</div>
                                <div style="font-size:0.8rem; color:#888; margin-top:20px;">Tap to flip</div>
                            </div>
                            <div class="card__face card__face--back">
                                <div style="white-space: pre-wrap;">${card.answer.replace(/\n/g, '<br>')}</div>
                            </div>
                        </div>
                    </div>
                    <div class="controls" style="display:flex; justify-content:center; gap:20px; margin-top:30px;">
                        <button class="control-btn" data-flash="prev">‚óÄ Previous</button>
                        <button class="control-btn" data-flash="next">Next ‚ñ∂</button>
                    </div>
                    <div style="text-align:center; margin-top:25px;">
                        <button data-action="backHome" style="background:none; border:none; color:rgba(255,255,255,0.7); text-decoration:underline; cursor:pointer;">‚Üê Back</button>
                    </div>
                `;
                dom.main.innerHTML = html;
                // Attach flip listener
                const cardEl = document.getElementById('flashcard');
                const scene = document.getElementById('cardScene');
                if (scene) scene.addEventListener('click', function flipHandler(e) {
                    if (e.target.closest('.control-btn')) return; // ignore nav buttons
                    cardEl.classList.toggle('is-flipped');
                }, { passive: true });
                utils.safeScrollTop();
            },

            quizSetup: function(chapterId) {
                const chapter = utils.getChapter(chapterId);
                if (!chapter) { router.navigate('home'); return; }
                state.activeChapter = chapterId;
                const html = `
                    <div class="quiz-setup-container">
                        <h2 style="color:#0056b3;">Quiz: ${chapter.shortTitle}</h2>
                        <p style="color:#666;">Select number of questions</p>
                        <div class="setup-grid">
                            <button class="setup-btn" data-quiz-size="10">10 Questions <span>‚Üí</span></button>
                            <button class="setup-btn" data-quiz-size="20">20 Questions <span>‚Üí</span></button>
                            <button class="setup-btn" data-quiz-size="30">30 Questions <span>‚Üí</span></button>
                            <button class="setup-btn challenge" data-quiz-size="${chapter.quiz.length}">All (${chapter.quiz.length}) <span>‚Üí</span></button>
                        </div>
                        <button data-action="backHome" style="margin-top:30px; background:none; border:none; color:#666; text-decoration:underline; cursor:pointer;">Cancel</button>
                    </div>
                `;
                dom.main.innerHTML = html;
                updateHeader('Quiz Setup', chapter.shortTitle, true);
                utils.safeScrollTop();
            },

            quizGame: function() {
                if (!state.quizData.length) { router.navigate('home'); return; }
                const q = state.quizData[state.qIndex];
                const progress = `Q ${state.qIndex+1}/${state.quizData.length}`;
                const optionsHtml = q.options.map((opt, idx) => 
                    `<button class="option-btn" data-opt-index="${idx}">${utils.escapeHTML(opt)}</button>`
                ).join('');
                const html = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; color:rgba(255,255,255,0.9);">
                        <span>${progress}</span>
                        <span>Score: <strong style="color:#fff;" id="currentScore">${state.score}</strong></span>
                    </div>
                    <div class="quiz-container">
                        <div style="font-size:1.15rem; font-weight:600; margin-bottom:20px; color:#222;">${utils.escapeHTML(q.q)}</div>
                        <div class="quiz-options" id="quizOptionsContainer">${optionsHtml}</div>
                        <div class="quiz-feedback" id="quizFeedback" style="display:none;"></div>
                        <button class="control-btn" id="nextQuizBtn" style="width:100%; margin-top:25px; display:none;">Next Question</button>
                    </div>
                `;
                dom.main.innerHTML = html;
                utils.safeScrollTop();
            },

            criticalGame: function(chapterId) {
                const chapter = utils.getChapter(chapterId);
                if (!chapter || !chapter.critical.length) { router.navigate('home'); return; }
                state.criticalData = chapter.critical;
                state.criticalIndex = 0;
                state.criticalScore = 0;
                this._renderCriticalQuestion();
                updateHeader('Critical Scenarios', chapter.shortTitle, true);
            },

            _renderCriticalQuestion: function() {
                const q = state.criticalData[state.criticalIndex];
                const optionsHtml = q.options.map((opt, idx) => 
                    `<button class="option-btn" data-opt-index="${idx}">${utils.escapeHTML(opt)}</button>`
                ).join('');
                const html = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span style="color:white;">Scenario ${state.criticalIndex+1}/${state.criticalData.length}</span>
                        <span style="color:white;">Score: <strong>${state.criticalScore}</strong></span>
                    </div>
                    <div class="critical-card">
                        <div style="background: #f8d7da; padding:15px; border-radius:12px; margin-bottom:20px;">
                            <strong style="color:#721c24;">üö® Scenario</strong>
                            <p style="margin-top:8px;">${utils.escapeHTML(q.scenario)}</p>
                        </div>
                        <div style="font-weight:600; margin-bottom:15px;">${utils.escapeHTML(q.question)}</div>
                        <div class="quiz-options" id="criticalOptionsContainer">${optionsHtml}</div>
                        <div class="critical-feedback" id="criticalFeedback" style="display:none;"></div>
                        <button class="control-btn" id="nextCriticalBtn" style="width:100%; margin-top:25px; display:none;">Next Scenario</button>
                    </div>
                `;
                dom.main.innerHTML = html;
                utils.safeScrollTop();
            },

            stats: function() {
                const s = state.stats;
                const chapStats = s.chapters['c1'] || { attempts:0, totalScore:0, totalMax:0 };
                const chapAvg = chapStats.totalMax ? Math.round((chapStats.totalScore/chapStats.totalMax)*100) : 0;
                const critAcc = s.critical.total ? Math.round((s.critical.correct/s.critical.total)*100) : 0;
                const html = `
                    <div class="stats-card">
                        <h2 style="color:#0056b3;">üìä Your Performance</h2>
                        <div style="margin-top:20px;">
                            <div style="display:flex; justify-content:space-between; padding:12px; background:rgba(0,0,0,0.02); border-radius:8px;">
                                <span>Total quiz attempts</span>
                                <strong>${s.totalAttempts}</strong>
                            </div>
                            <div style="display:flex; justify-content:space-between; padding:12px; margin-top:8px;">
                                <span>Universal Care avg.</span>
                                <strong>${chapAvg}%</strong>
                            </div>
                            <div style="display:flex; justify-content:space-between; padding:12px; background:rgba(0,0,0,0.02); border-radius:8px;">
                                <span>Critical accuracy</span>
                                <strong>${critAcc}%</strong>
                            </div>
                            <div style="display:flex; justify-content:space-between; padding:12px;">
                                <span>Mistakes recorded</span>
                                <strong>${state.mistakes.length}</strong>
                            </div>
                        </div>
                        <button class="control-btn" data-action="backHome" style="width:100%; margin-top:30px;">‚Üê Back</button>
                    </div>
                `;
                dom.main.innerHTML = html;
                updateHeader('Statistics', '', true);
                utils.safeScrollTop();
            },

            reviewMistakes: function() {
                if (!state.mistakes.length) { router.navigate('home'); return; }
                let items = state.mistakes.map(m => `
                    <div class="mistake-item">
                        <div class="mistake-question">‚ùì ${utils.escapeHTML(m.question)}</div>
                        <div class="mistake-answer">‚úÖ Correct: ${utils.escapeHTML(m.correctAnswer)}</div>
                        <div class="mistake-rationale">üìò ${utils.escapeHTML(m.rationale)}</div>
                    </div>
                `).join('');
                const html = `<div class="sum-card"><h3>üìù Mistakes Review</h3>${items}<button class="control-btn" data-action="backHome" style="width:100%; margin-top:20px;">‚Üê Back</button></div>`;
                dom.main.innerHTML = html;
                updateHeader('Mistakes', '', true);
                utils.safeScrollTop();
            }
        };

        // ---------- QUIZ ENGINE ----------
        const quizEngine = {
            init: function(chapterId, size) {
                const chapter = utils.getChapter(chapterId);
                if (!chapter) return;
                state.quizData = utils.shuffle(chapter.quiz).slice(0, size);
                state.qIndex = 0;
                state.score = 0;
                // increment attempts stat
                state.stats.totalAttempts = (state.stats.totalAttempts || 0) + 1;
                storage.save(state.stats);
                render.quizGame();
            },
            handleAnswer: function(selectedIdx, btn) {
                const q = state.quizData[state.qIndex];
                const isCorrect = selectedIdx === q.correct;
                if (isCorrect) state.score++;
                else {
                    // store mistake
                    state.mistakes.push({
                        question: q.q,
                        correctAnswer: q.options[q.correct],
                        rationale: q.explanation
                    });
                }
                // disable all options
                document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
                // highlight
                btn.classList.add(isCorrect ? 'correct' : 'wrong');
                if (!isCorrect) {
                    document.querySelectorAll('.option-btn')[q.correct].classList.add('correct');
                }
                // show feedback
                const fb = document.getElementById('quizFeedback');
                fb.style.display = 'block';
                fb.innerHTML = `<strong style="color:${isCorrect?'#155724':'#721c24'};">${isCorrect?'‚úÖ Correct':'‚ùå Incorrect'}</strong><p>${q.explanation}</p>`;
                document.getElementById('nextQuizBtn').style.display = 'block';
                document.getElementById('currentScore').innerText = state.score;
            },
            next: function() {
                state.qIndex++;
                if (state.qIndex < state.quizData.length) {
                    render.quizGame();
                } else {
                    // update chapter stats
                    const chapterId = state.activeChapter;
                    if (chapterId) {
                        if (!state.stats.chapters[chapterId]) state.stats.chapters[chapterId] = { attempts:0, totalScore:0, totalMax:0 };
                        const chap = state.stats.chapters[chapterId];
                        chap.attempts += 1;
                        chap.totalScore += state.score;
                        chap.totalMax += state.quizData.length;
                        storage.save(state.stats);
                    }
                    // show results
                    const percentage = Math.round((state.score / state.quizData.length)*100);
                    let msg = 'Keep studying!';
                    if (percentage >= 80) msg = 'Excellent!';
                    else if (percentage >= 60) msg = 'Good effort.';
                    const reviewBtn = state.mistakes.length ? `<button class="control-btn" data-action="reviewMistakes" style="margin-top:15px;">üìù Review ${state.mistakes.length} Mistakes</button>` : '';
                    const html = `
                        <div class="quiz-setup-container" style="text-align:center;">
                            <h2 style="color:#0056b3;">Quiz Complete!</h2>
                            <div style="font-size:3.5rem; font-weight:bold; color:#0056b3; margin:20px 0;">${percentage}%</div>
                            <p style="color:#666;">${msg}</p>
                            ${reviewBtn}
                            <button class="control-btn" data-action="backHome" style="margin-top:20px;">‚Üê Home</button>
                        </div>
                    `;
                    dom.main.innerHTML = html;
                    utils.safeScrollTop();
                }
            }
        };

        // ---------- CRITICAL ENGINE ----------
        const criticalEngine = {
            handleAnswer: function(selectedIdx, btn) {
                const q = state.criticalData[state.criticalIndex];
                const isCorrect = selectedIdx === q.correct;
                if (isCorrect) {
                    state.criticalScore++;
                    state.stats.critical.correct = (state.stats.critical.correct || 0) + 1;
                }
                state.stats.critical.total = (state.stats.critical.total || 0) + 1;
                storage.save(state.stats);

                document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
                btn.classList.add(isCorrect ? 'correct' : 'wrong');
                if (!isCorrect) {
                    document.querySelectorAll('.option-btn')[q.correct].classList.add('correct');
                }
                const fb = document.getElementById('criticalFeedback');
                fb.style.display = 'block';
                fb.innerHTML = `<strong style="color:${isCorrect?'#155724':'#721c24'};">${isCorrect?'‚úÖ Correct':'‚ùå Incorrect'}</strong>
                                <p style="margin-top:8px;">${q.explanation}</p>
                                ${q.kpi ? `<div class="highlight-box" style="margin-top:10px;">üéØ KPI: ${q.kpi}</div>` : ''}`;
                document.getElementById('nextCriticalBtn').style.display = 'block';
            },
            next: function() {
                state.criticalIndex++;
                if (state.criticalIndex < state.criticalData.length) {
                    render._renderCriticalQuestion();
                } else {
                    const accuracy = Math.round((state.criticalScore / state.criticalData.length)*100);
                    const html = `
                        <div class="quiz-setup-container" style="text-align:center;">
                            <h2 style="color:#0056b3;">Critical scenarios finished</h2>
                            <div style="font-size:3rem; font-weight:bold; color:#0056b3; margin:20px 0;">${accuracy}%</div>
                            <p>Correct: ${state.criticalScore}/${state.criticalData.length}</p>
                            <button class="control-btn" data-action="backHome" style="margin-top:20px;">‚Üê Home</button>
                        </div>
                    `;
                    dom.main.innerHTML = html;
                    utils.safeScrollTop();
                }
            }
        };

        // ---------- ROUTER (hash‚Äëbased) ----------
        const router = {
            navigate: function(route, param) {
                if (!route) route = 'home';
                let hash = route === 'home' ? '#home' : `#${route}`;
                if (param) hash += `/${param}`;
                location.hash = hash;
            },
            handle: function() {
                const hash = location.hash.slice(1) || 'home';
                const parts = hash.split('/');
                const route = parts[0];
                const id = parts[1];

                if (route === 'home') {
                    render.home();
                } else if (route === 'summary' && id) {
                    render.summary(id);
                } else if (route === 'flashcards' && id) {
                    render.flashcards(id);
                } else if (route === 'quiz' && id) {
                    render.quizSetup(id);
                } else if (route === 'critical' && id) {
                    render.criticalGame(id);
                } else if (route === 'stats') {
                    render.stats();
                } else if (route === 'reviewMistakes') {
                    render.reviewMistakes();
                } else {
                    router.navigate('home');
                }
            }
        };

        // ---------- EVENT DELEGATION (single listener) ----------
        document.addEventListener('click', function(e) {
            const target = e.target.closest('button');
            if (!target) return;
            const action = target.dataset.action;
            const chapter = target.dataset.chapter;
            const size = target.dataset.quizSize;

            // Navigation actions
            if (action === 'backHome') {
                router.navigate('home');
            }
            else if (action === 'summary' && chapter) {
                router.navigate('summary', chapter);
            }
            else if (action === 'flashcards' && chapter) {
                router.navigate('flashcards', chapter);
            }
            else if (action === 'quiz' && chapter) {
                router.navigate('quiz', chapter);
            }
            else if (action === 'critical' && chapter) {
                router.navigate('critical', chapter);
            }
            else if (action === 'stats') {
                router.navigate('stats');
            }
            else if (action === 'reviewMistakes') {
                router.navigate('reviewMistakes');
            }
            // Quiz size selection
            else if (target.classList.contains('setup-btn') && size) {
                const chapterId = state.activeChapter || 'c1';
                quizEngine.init(chapterId, parseInt(size,10));
            }
            // Quiz answer
            else if (target.classList.contains('option-btn') && target.closest('#quizOptionsContainer')) {
                const idx = parseInt(target.dataset.optIndex, 10);
                quizEngine.handleAnswer(idx, target);
            }
            // Critical answer
            else if (target.classList.contains('option-btn') && target.closest('#criticalOptionsContainer')) {
                const idx = parseInt(target.dataset.optIndex, 10);
                criticalEngine.handleAnswer(idx, target);
            }
            // Next question / critical
            else if (target.id === 'nextQuizBtn') {
                quizEngine.next();
            }
            else if (target.id === 'nextCriticalBtn') {
                criticalEngine.next();
            }
            // Flashcard navigation
            else if (target.dataset.flash === 'prev') {
                if (state.fIndex > 0) state.fIndex--;
                render._renderFlashcard();
            }
            else if (target.dataset.flash === 'next') {
                if (state.fIndex < state.flashData.length - 1) state.fIndex++;
                render._renderFlashcard();
            }
        });

        // ---------- INITIALISE ----------
        function init() {
            // Load stats
            state.stats = storage.load();
            // Set up hash change listener
            window.addEventListener('hashchange', router.handle);
            // Initial route
            if (!location.hash || location.hash === '#') {
                router.navigate('home');
            } else {
                router.handle();
            }
            // Home button click
            dom.homeBtn.addEventListener('click', function() {
                router.navigate('home');
            });
        }

        init();

        // Expose minimal API
        window.app = {
            navigate: router.navigate,
            state: state // for debugging
        };
    })();
</script>
</body>
</html>
